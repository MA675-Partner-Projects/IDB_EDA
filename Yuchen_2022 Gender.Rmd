---
title: "Gender"
author: "Yuchen Huang"
date: "2023-11-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read Data

```{r}
library(tidyverse)
ZZ22 <- read.csv("translated_ZZ22.csv")
#glimpse(ZZ22)
```


## remove cities have less than 22*50 = 110 voters
```{r}
ZZ22_gender <- ZZ22 |>
  select(CITY_CODE, CITY_NAME, GENDER)

#remove cities less than 110
ZZ22_gender <- ZZ22_gender |>
  group_by(CITY_CODE)|>
  filter(n()>=110) |>
  ungroup()

ZZ22_gender_wide <- ZZ22_gender |>
  group_by(CITY_CODE, GENDER) |>
  summarise(count = n()) |>
  pivot_wider(names_from = GENDER, values_from = count) |> 
  ungroup()

# replace NA with 0
ZZ22_gender_wide <- ZZ22_gender_wide |>
  mutate_all(~replace(., is.na(.), 0))
```

## Ordinal Distance function
```{r}
ev_multinom <- function (x, y) # KL divergence
  2 * sum(unlist(ifelse(x == 0 | y == 0, 0, x * log(x / y))))

l2_dist <- function (x, y) sum((x - y) ^ 2)

cat_dist <- function (x, y, deviance = FALSE) {
  wx <- sum(x); wy <- sum(y)
  m <- (x + y) / (wx + wy) # center
  x <- x / wx; y <- y / wy
  D <- if (deviance) dev_multinom else l2_dist
  sqrt(.5 * wx * D(x, m)) + sqrt(.5 * wy * D(y, m))
}

ord_dist <- function (x, y) {
  wx <- sum(x); wy <- sum(y)
  k <- length(x) # == length(y)
  x <- cumsum(x)[-k]; y <- cumsum(y)[-k]
  m <- (x + y) / (wx + wy) # center
  x <- x / wx; y <- y / wy
  sqrt(wx * l2_dist(x, m)) + sqrt(wy * l2_dist(y, m))
}


# use in tibbles


lower2dist <- function (m) {
  m <- as.matrix(m)
  n <- nrow(m) + 1 # == ncol(m) + 1
  d <- matrix(0, n, n)
  d[2:n, 1:(n - 1)] <- m
  as.dist(d)
}

tibble2dist <- function (t, dist_f, data_fields, ...) {
  t1 <- t |> mutate(id_ = row_number()) |> nest(data = all_of(data_fields))
  inner_join(t1, t1, by = join_by(id_ < id_)) |>
    mutate(dist = map2_dbl(data.x, data.y, dist_f, ...)) |>
    select(id_.x, id_.y, dist) |> spread(id_.x, dist, fill = 0) |>
    column_to_rownames(var = "id_.y") |> lower2dist()
}

plot_dist <- function (d, labels = seq_len(attr(d, "Size")), pos = 1, ...) {
  op <- par(mfrow = c(1, 2))
  plot(hclust(d, ...)) # hierarchical clustering
  z <- cmdscale(d) # classic multidimensional scaling (MDS)
  plot(z[,1], z[,2], xlab = "MDS1", ylab = "MDS2")
  text(z[,1], z[,2], labels, pos = pos)
  par(op)
  invisible(z)
}

```

## Distance
```{r}
data_fields_gender <- colnames(ZZ22_gender_wide)[-1]
(d <- tibble2dist(ZZ22_gender_wide, cat_dist, data_fields_gender))

plot_dist(d, labels = ZZ22_gender_wide$CITY_CODE)

```